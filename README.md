TwistedPrism
============

TwistedPrism is a Python/Twisted daemon to handle syndication of notifications
from and to multiple sources and destinations (mainly chat services). It's
intended to be a funnel for your various notifications into an IRC channel or
XMPP chat. It currently listens for either netcat (socket) or HTTP (GET url
params or form-encoded POST data) requests, and relays a simple string from
the input to an output (one or more IRC or XMPP channels/chats). 

This project is intended to provide an easy way to take simple string messages
from "things" that you want to know about (monitoring system alerts, tickets
or bug reports, CI/CD system job status, administrative tools, etc.) and allow
them to be broadcast into IRC or XMPP channels (or perhaps more outputs in the
future) with no more than a HTTP GET or POST, a simple string write to a
socket, or echoing to `netcat` in a shell script. 

Inputs
------
* netcat (socket)
* HTTP GET or POST

Outputs
-------
* IRC channel and/or user (multiple of each)
* XMPP/Jabber - direct user messaging only, no chats

Usage - Server
--------------

1. Copy `config.cfg.example` to `config.cfg` and edit as necessary for your
environment. Remove any sections you don't want. Each protocol section
supports multiple accounts, meaning you can have the bot on multiple IRC
networks, or multiple XMPP accounts.
2. Start the bot with `twistd -y twistedprism.tac`
3. If you have any issues, keep it in the foreground with `twistd -n -y twistedprism.tac`

Usage - Clients
---------------
I've decided (as much as practical) to unify the API for the various
inputs. I've decided on JSON as it has pretty wide-spread support in almost
every language I can think of, and if not, it's pretty easy to craft simple
JSON by hand and interpolate variables as needed. As such, the HTTP POST and
socket/netcat interfaces use the same JSON API, as does the HTTP GET interface
albeit with some limitations. So, data as described in the API section below
can be sent to any of the following interfaces:
* socket/netcat - Send JSON string to the server on the port used for netcat
(netcat.port in the config file). `echo "$JSON" | nc localhost 1079`, or
the equivalent socket code in the language of your choice.
* Send a HTTP GET to the server, /notification/send. Parameters are encoded in
the URL (standard URL encoded data) in the form
`/notification/send?$ENCODED_DATA`. (There are some additional restrictions
here, as specified in the API section below).
* __recommended:__ Send a HTTP POST of JSON to the server,
/notification/send. The JSON is an array following the API documentation below.

API Specification
------------------
Incoming data is sent as a JSON array (i.e. Python dict, Perl hash, Ruby hash, or
all of PHP). The HTTP GET API should match the JSON in key/value pairs,
with multivalue fields encoded as unquoted, comma separated fields (CSV).

* __message__ _(string)_ - the string message to send
* __users__ _(array)_ - a list of users to send to _(optional; defaults to the
  "default_users" array in config)_
* __channels__ _(array)_ - a list of channels to send to _(optional; defaults
  to the "default_channels" array in config)_

Anywhere that user(s) and/or channel(s) are not specified, the defaults from
the configuration file will be used. Users and channels are named globally -
if you define three IRC instances on different servers, all connected to
"#foo" on those separate servers, a message with 'users': ['foo'] will be sent
to all three "#foo"s.

contrib/
--------
The following files can be found in the `contrib/` directory:
* __nagios_notify_by_twistedprism.cfg__ - Nagios host and service notification
commands for notifying via TwistedPrism. 
* __init.d-twistedprism__ an init script generated by the `tap2rpm(1)` tool
for twistedprism.tac. This will (perhaps with some modifications for your
system or distro) allow TwistedPrism to run through twistd as a standard
daemon.

Configuration File
------------------
The daemon is configured by a simple YAML file. 

* __logging__: this hash configures the logging
   * __verbosity: X__, where X is an _integer_ in the following set:
      * 1 - normal logging. Log only critical issues.
      * 2 - verbose logging. Log major events in program flow.
      * 3 - debug logging. log everything. and we mean everything.
* __irc__: configuration for IRC servers
   * __NAME__: _string_, configuration for one server, called "NAME" _(NAME
     only used internally)_
      * __server__: _string_, hostname or IP of IRC server
      * __port__: _integer_, server port number
      * __ssl__: _boolean_, True or False, whether or not to use SSL.
      * __nick__: _string_, nick to use in the channels
      * __user__: _string_, username to login with
      * __realname__: _string_, Real Name to use in CTCP Finger
      * __pass__: _string_, password to login
      * __lineRate__: _integer_, maximum lines per second to send to server
      * __heartbeatInterval__: _integer_, on Twisted versions high enough to
        implement it (11.1.0+), send heartbeat every this number of seconds
      * __channels__: _list_ of channels to join.
         * __key__: _string, optional_, secret for joining channel
      * __users__: _list_ of users to message
      * __default_channels__: _list, optional_, channels to message when none
        are specified in incoming request
      * __default_users__: _list, optional_, users to message when none
        are specified in incoming request
* __xmpp__: configuration for XMPP/Jabber
   * __username__: _string_, username to login to server with
      * __pass__: _string_, secret to login with
      * __users__: _list, optional_, users to message when none are specified
        in incoming request

Known Issues
------------
* The IRC heartbeat functionality wasn't implemented in Twisted until
11.1.0. If you're on an older OS, be aware that without it, connections to
certain IRC servers (specifically those behind load balancers and using SSL)
may drop and reconnect at regular intervals.

To Do
------
* Simple "authentication" - cleartext name/secret combinations sent along with
requests, matched against same in a server-side YAML. Not for security, but as
a means of "shutting off" unruly or runaway client applications by changing
the secret.
* I'd like to migrate away from twistd to something that will work well across
all OSes, have native init scripts (at least for RedHat/CentOS, Fedora,
Debian, Ubuntu and Mac OSX), and work well installed in a venv with minimal
system-wide software requirements. Alas, I don't have the Python skills to do
this. Pull requests welcome.
* Tests. Unit tests, and some way of doing full-fledged network tests.

Acknowledgements
----------------

The code I began working on was a GitHub repo forked from that of Azelphur
Gaming [TwistedCat](https://github.com/Azelphur/TwistedCat). He in turn says
that the IRC protocol class came from [Eric Florenzano's Blog
post](http://eflorenzano.com/blog/2008/11/16/writing-markov-chain-irc-bot-twisted-and-python/).

License
-------
Unknown. Neither of the two people whose code has gone into this published
notice of a specific license for their work. I'd like to say 'something along
the spirit of the GPLv3'. Or, in more concrete terms, do whatever you want
with this so long as you make every effort to send changes/improvements back
to me (ideally by forking the repository and sending a pull request), 
report any bugs that you find, and keep author/contributor information intact.
